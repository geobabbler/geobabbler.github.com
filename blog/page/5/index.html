
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>geoMusings</title>
  <meta name="author" content="Bill Dollins">

  
  <meta name="description" content="A while back, I was working on a project that required us to rotate a polygon around a base point and do a spatial query to analyze some underlying &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.geomusings.com/blog/page/5/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="geoMusings" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">geoMusings</a></h1>
  
    <h2>geospatial technologies and practices</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.geomusings.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/resources">Resources</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2007/06/25/Rotating-a-Point-Around-a-Base-Point/">Rotating a Point Around a Base Point</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-06-25T00:00:00-04:00" pubdate data-updated="true">Jun 25<span>th</span>, 2007</time>
        
         | <a href="/2007/06/25/Rotating-a-Point-Around-a-Base-Point/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A while back, I was working on a project that required us to rotate a polygon around a base point and do a spatial query to analyze some underlying demographic data. I was working in ArcObjects and could find no intrinsic way to do what I needed to do so I wrote the following routine. As you can imagine, I had to break the polygon up into individual points and rotate each one. Despite the fact that I was using ArcObjects point objects and all of the attendant COM interop calls, it worked pretty well (a polygon consisting of ~5000 point was rotated in less than a second on a less-than-robust workstation).</p>

<p>The math is pretty simple: Assuming that the base point and target point form the two ends of the hypotenuse of a right triangle with one leg of the triangle being a segment of the X axis, you simply:</p>

<ol>
    <li>Calculate the length of the hypotenuse</li>
    <li>Calculate the current angle of the hypotenuse</li>
    <li>Add the rotation angle to the current angle</li>
    <li>Calculate the coordinates of the new end point of the hypotenuse</li>
</ol>


<p>The code below shows how to do it but there are a couple of notes about it:</p>

<ul>
    <li>The coordinates must be in decimal degrees so you&#8217;ll need to unproject any projected coordinates and then re-project the result. This <em>may</em> introduce some distortion. I didn&#8217;t notice any in my application but I&#8217;d suggest some more rigorous testing if you&#8217;ve got tight precision requirements.</li>
    <li>Rotation follows engineering standards (zero East, counter-clockwise)</li>
    <li>This code is only mildly based on ArcObjects. It uses the AO IPoint interface and Point but that&#8217;s it. It is trival to implement it with another point object (such as SharpMap) or just use numeric values.</li>
    <li>The base point is shifted to 0,0 and the same offset is applied to all other points in order to keep the math straightforward.</li>
    <li>It&#8217;s in C#</li>
</ul>


<p>So there it is. It&#8217;s fairly simple but it&#8217;s been useful for me on a couple of occasions since I wrote it.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'> <span class="k">private</span> <span class="n">IPoint</span> <span class="nf">rotatePoint</span><span class="p">(</span><span class="n">IPoint</span> <span class="n">basePoint</span><span class="p">,</span> <span class="n">IPoint</span> <span class="n">sourcePoint</span><span class="p">,</span> <span class="kt">double</span> <span class="n">rotationAngle</span><span class="p">)</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'>     <span class="kt">double</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>     <span class="kt">double</span> <span class="n">theta</span><span class="p">;</span>
</span><span class='line'>     <span class="kt">double</span> <span class="n">offsetX</span><span class="p">;</span>
</span><span class='line'>     <span class="kt">double</span> <span class="n">offsetY</span><span class="p">;</span>
</span><span class='line'>     <span class="kt">double</span> <span class="n">offsetTheta</span><span class="p">;</span>
</span><span class='line'>     <span class="kt">double</span> <span class="n">rotateX</span><span class="p">;</span>
</span><span class='line'>     <span class="kt">double</span> <span class="n">rotateY</span><span class="p">;</span>
</span><span class='line'>     <span class="kt">double</span> <span class="n">rotationRadians</span><span class="p">;</span>
</span><span class='line'>     <span class="n">IPoint</span> <span class="n">retPoint</span><span class="p">;</span>
</span><span class='line'>     <span class="k">try</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>         <span class="c1">//shift x and y relative to 0,0 origin </span>
</span><span class='line'>         <span class="n">offsetX</span> <span class="p">=</span> <span class="p">(</span><span class="n">sourcePoint</span><span class="p">.</span><span class="n">X</span> <span class="p">+</span> <span class="p">(</span><span class="n">basePoint</span><span class="p">.</span><span class="n">X</span> <span class="p">*</span> <span class="p">-</span><span class="m">1</span><span class="p">));</span>
</span><span class='line'>         <span class="n">offsetY</span> <span class="p">=</span> <span class="p">(</span><span class="n">sourcePoint</span><span class="p">.</span><span class="n">Y</span> <span class="p">+</span> <span class="p">(</span><span class="n">basePoint</span><span class="p">.</span><span class="n">Y</span> <span class="p">*</span> <span class="p">-</span><span class="m">1</span><span class="p">));</span>
</span><span class='line'>         <span class="c1">//convert to radians. take absolute value (necessary for x coord only). </span>
</span><span class='line'>         <span class="n">offsetX</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="n">Abs</span><span class="p">(</span><span class="n">offsetX</span> <span class="p">*</span> <span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="n">PI</span> <span class="p">/</span> <span class="m">180</span><span class="p">));</span>
</span><span class='line'>         <span class="n">offsetY</span> <span class="p">=</span> <span class="n">offsetY</span> <span class="p">*</span> <span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="n">PI</span> <span class="p">/</span> <span class="m">180</span><span class="p">);</span>
</span><span class='line'>         <span class="n">rotationRadians</span> <span class="p">=</span> <span class="n">rotationAngle</span> <span class="p">*</span> <span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="n">PI</span> <span class="p">/</span> <span class="m">180</span><span class="p">);</span>
</span><span class='line'>         <span class="c1">//get distance from origin to source point </span>
</span><span class='line'>         <span class="n">r</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="n">Sqrt</span><span class="p">(</span><span class="n">Math</span><span class="p">.</span><span class="n">Pow</span><span class="p">(</span><span class="n">offsetX</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span> <span class="p">+</span> <span class="n">Math</span><span class="p">.</span><span class="n">Pow</span><span class="p">(</span><span class="n">offsetY</span><span class="p">,</span> <span class="m">2</span><span class="p">));</span>
</span><span class='line'>         <span class="c1">//get current angle of orientation </span>
</span><span class='line'>         <span class="n">theta</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="n">Atan</span><span class="p">(</span><span class="n">offsetY</span> <span class="p">/</span> <span class="n">offsetX</span><span class="p">);</span>
</span><span class='line'>         <span class="c1">// add rotation value to theta to get new angle of orientation </span>
</span><span class='line'>         <span class="n">offsetTheta</span> <span class="p">=</span> <span class="n">theta</span> <span class="p">+</span> <span class="n">rotationRadians</span><span class="p">;</span>
</span><span class='line'>         <span class="c1">//calculate new x coord </span>
</span><span class='line'>         <span class="n">rotateX</span> <span class="p">=</span> <span class="n">r</span> <span class="p">*</span> <span class="n">Math</span><span class="p">.</span><span class="n">Cos</span><span class="p">(</span><span class="n">offsetTheta</span><span class="p">);</span>
</span><span class='line'>         <span class="c1">//calculate new y coord </span>
</span><span class='line'>         <span class="n">rotateY</span> <span class="p">=</span> <span class="n">r</span> <span class="p">*</span> <span class="n">Math</span><span class="p">.</span><span class="n">Sin</span><span class="p">(</span><span class="n">offsetTheta</span><span class="p">);</span>
</span><span class='line'>         <span class="c1">//convert new x and y back to decimal degrees </span>
</span><span class='line'>         <span class="n">rotateX</span> <span class="p">=</span> <span class="n">rotateX</span> <span class="p">*</span> <span class="p">(</span><span class="m">180</span> <span class="p">/</span> <span class="n">Math</span><span class="p">.</span><span class="n">PI</span><span class="p">);</span>
</span><span class='line'>         <span class="n">rotateY</span> <span class="p">=</span> <span class="n">rotateY</span> <span class="p">*</span> <span class="p">(</span><span class="m">180</span> <span class="p">/</span> <span class="n">Math</span><span class="p">.</span><span class="n">PI</span><span class="p">);</span>
</span><span class='line'>         <span class="c1">//shift new x and y relative to base point </span>
</span><span class='line'>         <span class="n">rotateX</span> <span class="p">=</span> <span class="p">(</span><span class="n">rotateX</span> <span class="p">+</span> <span class="n">basePoint</span><span class="p">.</span><span class="n">X</span><span class="p">);</span>
</span><span class='line'>         <span class="n">rotateY</span> <span class="p">=</span> <span class="p">(</span><span class="n">rotateY</span> <span class="p">+</span> <span class="n">basePoint</span><span class="p">.</span><span class="n">Y</span><span class="p">);</span>
</span><span class='line'>         <span class="c1">//return new point </span>
</span><span class='line'>         <span class="n">retPoint</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PointClass</span><span class="p">();</span>
</span><span class='line'>         <span class="n">retPoint</span><span class="p">.</span><span class="n">X</span> <span class="p">=</span> <span class="n">rotateX</span><span class="p">;</span>
</span><span class='line'>         <span class="n">retPoint</span><span class="p">.</span><span class="n">Y</span> <span class="p">=</span> <span class="n">rotateY</span><span class="p">;</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">retPoint</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>     <span class="k">catch</span>
</span><span class='line'>     <span class="p">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">sourcePoint</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2007/05/09/Creating-ArcObjects-Spatial-Reference-Objects-From-PostGIS-Spatial-Reference-Definitions/">Creating ArcObjects Spatial Reference Objects From PostGIS Spatial Reference Definitions</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-05-09T00:00:00-04:00" pubdate data-updated="true">May 9<span>th</span>, 2007</time>
        
         | <a href="/2007/05/09/Creating-ArcObjects-Spatial-Reference-Objects-From-PostGIS-Spatial-Reference-Definitions/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As discussed in my previous post, I&#8217;m trying to beef up the spatial reference support in zigGIS. I am doing this mainly to introduce support for user-defined spatial references. It pretty much boils down to querying the the appropriate SR from the PostGIS spatial_ref_sys table and applying the value of the srtext column to create a spatial reference in ArcObjects.</p>

<p>This approach has a few advantages and disadvantages. First, the advantages. Although both PostGIS and ESRI implement the EPSG spatial reference codes, there is not a one-to-one match between the two. Therefore, you could get an SRID in PostGIS that&#8217;s not supported in ArcGIS. The approach described above should alleviate that, adding stability. Secondly, if you&#8217;ve created a user-defined spatial reference in PostGIS, you should be able to use it in ArcGIS.</p>

<p>The disadvantages are relatively minor. First, all of the spatial references, even those created from standard EPSG SRs will appear to ArcGIS as custom spatial references, mainly because of the differing syntax of the SR string. Also, some unit definitions from PostGIS are not specifically recognized by ArcGIS. For instance &#8220;US survey feet&#8221; is shown as &#8220;unknown&#8221; in ArcGIS. This last one may be more than minor, depending on if it has any effect on distance calculations and the like but I haven&#8217;t gotten around to testing it yet.</p>

<p>So, how about some code? Here&#8217;s a C# routine that I&#8217;m developing for zigGIS (don&#8217;t look, it&#8217;s not there yet). It&#8217;s based on a previous routine that Paolo and I developed. I should note that the Connection and AutoDataReader objects are zigGIS classes that inherit from ADO.NET classes. You should be able to replace them with standard OleDbConnection and DataReader objects and be fine.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>        <span class="k">static</span> <span class="k">public</span> <span class="n">ISpatialReference</span> <span class="nf">setEsriSpatiaReferenceFromSrText</span><span class="p">(</span><span class="kt">int</span> <span class="n">srid</span><span class="p">,</span> <span class="n">Connection</span> <span class="n">conn</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">ISpatialReference</span> <span class="n">sr</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UnknownCoordinateSystemClass</span><span class="p">();</span>
</span><span class='line'>            <span class="kt">string</span> <span class="n">srText</span> <span class="p">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>            <span class="k">try</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="c1">//Bill: query srtext associated with srid</span>
</span><span class='line'>                <span class="n">AutoDataReader</span> <span class="n">dr</span> <span class="p">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">doQuery</span><span class="p">(</span><span class="s">&quot;select * from spatial_ref_sys where srid = &quot;</span> <span class="p">+</span> <span class="n">srid</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">dr</span><span class="p">.</span><span class="n">Read</span><span class="p">())</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="n">srText</span> <span class="p">=</span> <span class="n">dr</span><span class="p">[</span><span class="s">&quot;srtext&quot;</span><span class="p">]</span> <span class="p">+</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">ISpatialReferenceFactory2</span> <span class="n">srf</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SpatialReferenceEnvironmentClass</span><span class="p">();</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="n">srText</span> <span class="p">==</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">{</span>
</span><span class='line'>                        <span class="n">sr</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UnknownCoordinateSystemClass</span><span class="p">();</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="k">else</span>
</span><span class='line'>                    <span class="p">{</span>
</span><span class='line'>                        <span class="c1">//use srText to construct SR.</span>
</span><span class='line'>                        <span class="n">srf</span><span class="p">.</span><span class="n">CreateESRISpatialReference</span><span class="p">(</span><span class="n">srText</span><span class="p">,</span> <span class="k">out</span> <span class="n">sr</span><span class="p">,</span> <span class="k">out</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">sr</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">catch</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="c1">//PostGis srid is not implemented as an Esri Factory Code</span>
</span><span class='line'>                <span class="n">sr</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UnknownCoordinateSystemClass</span><span class="p">();</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">sr</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2007/02/21/Working-with-.zig-files/">Working With .zig Files</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-02-21T00:00:00-05:00" pubdate data-updated="true">Feb 21<span>st</span>, 2007</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The last couple of days have shown some traffic being driven to my blog from search terms such as &#8220;opening zig file&#8221; so I thought I&#8217;d offer up a discussion of the format.</p>

<p>Abe Gillespie, the original developer of <a href="http://code.google.com/p/ziggis">zigGIS</a>, developed the zig file as a means of persisting PostGIS connection information used to access a layer and display it in ArcMap. He threw us a blast from the past by choosing the old Windows INI format as the zig file syntax. I admire the choice because, truth be told, I still use that format from time to time. For simple configuration information, it&#8217;s more efficient than XML.</div>
  
  
    <footer>
      <a rel="full-article" href="/2007/02/21/Working-with-.zig-files/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2006/12/29/zigGIS-and-Spatial-References-Part-2/">zigGIS and Spatial References, Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2006-12-29T00:00:00-05:00" pubdate data-updated="true">Dec 29<span>th</span>, 2006</time>
        
         | <a href="/2006/12/29/zigGIS-and-Spatial-References-Part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Update to <a href="http://geobabble.wordpress.com/2006/12/21/ziggis-and-spatial-references/">this post</a>:</p>

<p>Another post about zigGIS. I didn&#8217;t really intend this blog to be so dominated by zigGIS but that&#8217;s certainly the way it&#8217;s been thus far. Basically, it&#8217;s just really cool and it satisfies my geek nature on a couple of fronts.</p>

<p>After posting about the spatial reference issue before, I couldn&#8217;t resist digging into it. I found a placeholder in the implementation of IFeatureClass.  Abe G. had even left a comment there that he needed to go back and implement it. So I dove in&#8230;</p>

<p>In the IFeatureClass implementation of CPostGisFeatureClass the SpatialReference property was stubbed out to always return and UnknownCoordinateSystem object. The feature class wraps a CLayer object (among others). This is the object I needed to use to get the spatial reference. The loadLayer method of CLayer (in the postgis_connector project) contained the following code:</p>

<pre>
<span class="kwrd">string</span> sql = CDbHelper.createSelectSql
(CPostGisConstants.geometryColumnsTable + <span class="str">" as g"</span>,
<span class="str">"g.*,g.oid,s."</span> + CPostGisConstants.spatialReferenceSrField,
<span class="str">"left join "</span> + CPostGisConstants.spatialReferenceTable + 
<span class="str">" as s on g."</span> +
CPostGisConstants.spatialReferenceIdField + <span class="str">"=s."</span> +
CPostGisConstants.spatialReferenceIdField,
<span class="kwrd">where</span>);
</pre>


<p>This code queries the geometry_columns table for all of the metadata I need. So I added the following code to the CLayer class:</p>

<pre>
<span class="kwrd">private</span> <span class="kwrd">int</span> m_srid = -1;
<span class="kwrd">public</span> <span class="kwrd">int</span> srid { get { <span class="kwrd">return</span> m_srid; } }
</pre>


<p>I then added this code to the loadLayer method&#8230;</p>

<pre>
m_srid = (<span class="kwrd">int</span>)((Int32)dr[<span class="str">"srid"</span>]);
</pre>


<p>&#8230;in order to expose the srid for the layer. The variable dr refers to an instance of the CAutoDataReader class defined in the postgis_connector project.</p>

<p>Finally, i added the following code to the init method of the CPostGisFeatureClass class in the postgis_geodatabase project:</p>

<pre>
<span class="kwrd">if</span> (m_layer.srid != -1)
{
    ISpatialReferenceFactory2 srfact = <span class="kwrd">new</span> SpatialReferenceEnvironmentClass();
    m_spaRef = srfact.CreateSpatialReference(m_layer.srid);
}
</pre>


<p>With that, the layer properties dialog in ArcMap correctly reports my spatial reference and the geometry that once failed to draw now works fine. I&#8217;ve got some more clean-up to do to the code to add some error-handling and the like. I&#8217;m sure it wouldn&#8217;t take much to crash it right now.</p>

<p>I think the thing I like about zigGIS is that it&#8217;s got something for everyone. ArcObjects geeks will appreciate the implementation of feature classes, cursors and the like. .NET geeks will appreciate nuggets like the CAutoDataReader class which is an implementation of the IDataReader interface. All in all, it&#8217;s a nice piece of work that I find more to like about as I dig deeper.</p>

<p>As I mentioned before, the project has a new home in Google Code and the discussion forum is getting a little more active so maybe zigGIS will gain a little more momentum. That&#8217;s all for now&#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2006/12/28/Why-Isnt-ArcGIS-Explorer-Open-Source/">Why Isn&#8217;t ArcGIS Explorer Open Source?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2006-12-28T00:00:00-05:00" pubdate data-updated="true">Dec 28<span>th</span>, 2006</time>
        
         | <a href="/2006/12/28/Why-Isnt-ArcGIS-Explorer-Open-Source/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was tinkering with AGX today, mainly trying to get comfortable with the API. As I was playing with it, this thought crept into my head: Why isn&#8217;t this thing open source? Okay, aside from the fact that it was released by ESRI&#8230;</p>

<p>There are two main reasons that I ponder this: First, it&#8217;s already free. ESRI isn&#8217;t charging for it so it&#8217;s essentially a cost sink for them. ESRI still incurs all of the costs associated with lifecycle maintenance with no direct recovery of those costs. Yes, I know that they are diffused across the revenue streams of the rest of the product line but bear with me. One could make a strong case that by making AGX open-source, ESRI&#8217;s overall costs would go down. Right now, they shoulder 100% of the cost. By opening up the product to a community of developers, that cost would go down. Basically, I don&#8217;t think that a free, closed-source AGX is going give ESRI much traction anywhere so you could call this the &#8220;what-have-they-got-to-lose&#8221; argument.</p>

<p>Secondly, there&#8217;s Google Earth. I will say right now that GE is a superior product to AGX. I won&#8217;t even try to debate otherwise. That said, AGX is pretty good. I know that ESRI has said that AGX is not intended to compete with GE. It&#8217;s targeted at the enterprise environment where it would be the &#8220;spinny globe&#8221; client to their server software. This is precisely the environment where GE starts to cost a good bit of money. By taking AGX open-source, ESRI could accelerate the advancement of the product while reducing costs and have it remain competitive. I think AGX will go over just fine in shops that are already using ESRI&#8217;s software but I don&#8217;t think it&#8217;s compelling enough to expand their market on its own. But, with its ability to consume KML, WMS, ArcIMS and ArcGIS Server as well as with its API; AGX has got a little game. Taking it open-source could potentially open up a whole new community of advocates who would have a little pride of ownership.</p>

<p>There are other smaller reasons to do it as well. ESRI has started dabbling in the open-source world with the <a href="http://gismatters.blogspot.com/2006/10/open-source-gis-52north-and-esri.html">52 North</a> initiative. Opening the source to AGX would certainly demonstrate commitment there. Also, this particular market segment is crowded: GE, AGX, World Wind, Virtual Earth 3D. AGX, as it stands now, adds little to the picture. An open-source AGX would at least add something to the community.</p>

<p>The main downside would be the difficulty in synchronizing the activity of an open-source project with the release schedule of ArcGIS. In addition, ESRI could risk losing control of the product altogether but there are enough models of open-source projects with corporate backing, such as <a href="http://www.eclipse.org">Eclipse</a>, to work from.</p>

<p>So, maybe it makes sense and maybe not. I could probably argue it either way for quite a while. AGX plugs a gap in the ESRI product line that&#8217;s existed for a long time and maybe that&#8217;s good enough for them. It&#8217;s most likely a complete non-starter. But again, it&#8217;s a free product. So, if it&#8217;s free, maybe it should be set free.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2006/12/27/zigGIS-on-Google-Code/">zigGIS on Google Code</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2006-12-27T00:00:00-05:00" pubdate data-updated="true">Dec 27<span>th</span>, 2006</time>
        
         | <a href="/2006/12/27/zigGIS-on-Google-Code/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It seems this is quickly turning into the zigGIS blog. Anyway, it appears that <a href="http://www.paolocorti.net">Paolo Corti</a> has assumed the role of project lead on zigGIS and has moved it to <a href="http://code.google.com/p/ziggis/">Google Code</a>. I&#8217;m excited because I think this is a great project and this should keep it moving forward. There&#8217;s also a group for discussing the project.</p>

<p>Thanks to Abe Gillespie and Paolo for collaborating to keep zigGIS going.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2006/12/21/zigGIS-and-Spatial-References/">zigGIS and Spatial References</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2006-12-21T00:00:00-05:00" pubdate data-updated="true">Dec 21<span>st</span>, 2006</time>
        
         | <a href="/2006/12/21/zigGIS-and-Spatial-References/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;m still playing around with zigGIS and I have noticed that it doesn&#8217;t seem to play well when I define the spatial reference of a data set in PostGIS. Any data set that has a defined spatial reference fails to draw in ArcMap. In addition, the layer properties always indicate that the coordinate system is undefined, whether on exists or not. This leads me to belienve that zigGIS is not handling the spatial references well.</p>

<p><a href="http://geobabble.files.wordpress.com/2006/12/where_are_my_states.png"><img src="http://geobabble.files.wordpress.com/2006/12/where_are_my_states.thumbnail.png" /></a>
As you can see, the dtl_st layer does not draw in ArcMap. I imported it into PostGIS using shp2pgsql with an SRID of 4326 (WGS84). The others layers were loaded with an SRID of -1.</p>

<p><a href="http://geobabble.files.wordpress.com/2006/12/there_they_are.png"><img src="http://geobabble.files.wordpress.com/2006/12/there_they_are.thumbnail.png" style="float: left; cursor: hand; margin: 0 10px 10px 0;" /></a>
As shown, the layer draws fine in QGIS. I will need to dig into the zigGIS code a little more to see about this one.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2006/12/19/About/">About</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2006-12-19T00:00:00-05:00" pubdate data-updated="true">Dec 19<span>th</span>, 2006</time>
        
         | <a href="/2006/12/19/About/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img alt="" class="alignleft size-medium wp-image-3109" height="195" src="http://geobabble.files.wordpress.com/2010/07/bill_medium.png?w=109" title="" width="141" /></p>

<p>My name is Bill Dollins and I am a consultant specializing in the integration of geospatial technologies into mainstream IT environments. I have been working primarily for US Federal and DoD organizations since the early 1990s. During that time, I have worked with most major commercial and open-source geospatial technologies, as well as most major programming languages and database platforms. I am equally comfortable with web, desktop and mobile development.</p>

<p>I am a Senior Vice President at <a href="http://www.zekiah.com">Zekiah Technologies</a> where I lead many geospatial efforts in support of our customers. This is my personal blog on matters related to programming, geospatial technologies, consulting and any other issues that may cross my mind.</p>

<p>I am available for consulting for projects related to geospatial technologies, software development, system design or implementation. I can be reached by e-mail at <a href="mailto:bill@geomusings.com?subject=Blog Visit">bill@geomusings.com</a> .</p>

<p>Or you can follow me on <a href="http://twitter.com/billdollins">Twitter</a>, <a href="http://www.linkedin.com/in/billdollins">LinkedIn</a> or <a href="https://plus.google.com/103048542132426664956/posts">Google Plus</a>.</p>

<p><a href="http://www.statcounter.com/" target="_blank"><img alt="website tracker" border="0" src="http://c36.statcounter.com/3206921/0/658cc815/0/" /></a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2006/12/17/PostGIS-and-ArcGIS-9.1/">PostGIS and ArcGIS 9.1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2006-12-17T00:00:00-05:00" pubdate data-updated="true">Dec 17<span>th</span>, 2006</time>
        
         | <a href="/2006/12/17/PostGIS-and-ArcGIS-9.1/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve been intrigued for some time by an open-source (GPL) project out there called <a href="http://code.google.com/p/ziggis/">zigGIS</a>. It is a C# project that enables a direct read of PostGIS by ArcGIS. It is intriguing for a couple of reasons. First is the promise of reading directly from PostGIS and working with your data in ArcMap without the need to create intermediate shapefiles or some other ESRI-friendly data format. Second is the fact that the project is a good example of the &#8220;correct&#8221; way to extend data support in ArcGIS. That&#8217;s to say the authors built the necessary workspace, feature class, and cursor objects to behave like any other set of geodatabase objects. As an ArcObjects developer, having a working example of this, with source code, was irresistable.</p>

<p>I had originally downloaded it about a year ago but let it sit because it only supported ArcGIS 8.x. I recently went back to it discover an updated version but still only 8.x support. I had a little more time on my hands this time and decided to do the upgrade to 9.1 myself.</p>

<p>The ArcObjects upgrade was fairly painless but I&#8217;ve done that a few times now. I found the documentation to be a little thin on some of the project&#8217;s dependencies. Specifically, there are several external open-source projects that zigGIS is dependent upon: log4net, npgsql, nini. While the readme specifies these, it doesn&#8217;t mention version numbers. This created the greatest issue with npgsql due to the fact that the zigGIS developers build a custom version for zigGIS.</p>

<p>The install instructions indicate that you should get npgsql from the pgFoundry and then replace the DLL with custom one for zigGIS. The problem arose from the fact that npgsql has been updated and it also has a dependency on Mono.Security.dll. The latest version of npgsql.dll uses version 2.0 of Mono.Security.dll but the version used by zigGIS uses version 1.0.5 of Mono.Security.</p>

<p>Once I sorted this out, I used the ESRI developer tools to remove references to ESRI.ArcObjects.Core and replace them with the necessary 9.1 libraries. ZigGIS comes with a VS2005 solution but I highly recommend following the developers&#8217; instructions and using nant to do your build. They provide their build script and it needs to be updated for 9.1 but it works great. The cursor and geodatabase projects introduce the kind of circular references that Visual Studio doesn&#8217;t like but that nant handles nicely.</p>

<p><a href="http://geobabble.files.wordpress.com/2006/12/postgis_arcmap.png"><img alt="POSTGIS Data in ArcMap with identify window." border="0" src="http://geobabble.files.wordpress.com/2006/12/postgis_arcmap.thumbnail.png" style="float: left; cursor: hand; margin: 0 10px 10px 0;" /></a> After I got the project to build, I was able to access data directly from PostGIS. This screen shot shows a sample data set in ArcMap. I&#8217;m running PostgreSQL 8.2 with PostGIS 1.2.0 on a Windows XP box. I loaded this data into PostGIS using the shp2pgsql utility that ships with PostGIS. The utility of zigGIS is readily apparent but its approach holds wider promise. There are numerous other data sources and open-source projects that could be integrated using the approach the zigGIS team has laid out here. <a href="http://mitab.maptools.org/">MITAB</a> is one that springs to mind.</p>

<p>Despite some of the issues I had with the build process, I got the project up and running in less than a day. Given the results, that seems like a worthy investment of time.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2006/12/02/Good-Article-on-Optimizing-Open-Source-Software/">Good Article on Optimizing Open-Source Software</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2006-12-02T00:00:00-05:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2006</time>
        
         | <a href="/2006/12/02/Good-Article-on-Optimizing-Open-Source-Software/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There&#8217;s been a lot of recent buzz about open-source GIS software. Good discussions can be found at <a href="http://www.spatiallyadjusted.com/category/open-source/" target="blank">James Fee&#8217;s site</a>, plus <a href="http://gispro.wordpress.com/" target="blank">Datum Shift</a> as well as on <a href="http://blog.davebouwman.net/default.aspx" target="blank">Dave Bouwman&#8217;s blog</a>.</p>

<p>Given all of this discussion, I found this <a href="http://www.ddj.com/dept/opensource/193501014;jsessionid=ZNJIVAZ2NVHSQQSNDLOSKH0CJUNN2JVN" target="blank">article</a> in <a href="http://www.ddj.com" target="blank">Dr. Dobb&#8217;s Journal </a>to be rather timely. It&#8217;s not about GIS software <em>per se </em>but it&#8217;s definitely relevant.</p>

<p>DDJ has undergone some changes of late but I still find it incredibly informative. That said, I still miss opening it up to find <a href="http://www.regdeveloper.co.uk/verity_stob/" target="blank">Verity Stob</a>.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/6/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/4/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/11/27/Put-Planet-Geospatial-to-Work-for-You/">Put Planet Geospatial to Work for You</a>
      </li>
    
      <li class="post">
        <a href="/2012/11/26/SpatiaLite-for-Android-Available/">SpatiaLite for Android Available</a>
      </li>
    
      <li class="post">
        <a href="/2012/11/26/SpatiaLite-4.0-Released/">SpatiaLite 4.0 Released</a>
      </li>
    
      <li class="post">
        <a href="/2012/11/19/The-Biggest-News-You-May-Have-Missed/">The Biggest News You May Have Missed&#8230;</a>
      </li>
    
      <li class="post">
        <a href="/2012/11/14/A-GIS-Day-Map-for-World-Diabetes-Day/">A GIS Day Map for World Diabetes Day</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/geobabbler">@geobabbler</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'geobabbler',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("billdollins", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/billdollins" class="twitter-follow-button" data-show-count="false">Follow @billdollins</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/103048542132426664956?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Bill Dollins -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'geomusings';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=2901378; 
var sc_invisible=1; 
var sc_security="be706774"; 
</script>
<script type="text/javascript"
src="http://www.statcounter.com/counter/counter.js"></script>
<noscript><div class="statcounter"><a title="web counter"
href="http://statcounter.com/free-hit-counter/"
target="_blank"><img class="statcounter"
src="http://c.statcounter.com/2901378/0/be706774/1/"
alt="web counter"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->


</body>
</html>
